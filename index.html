<html>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="./js/jquery-1.7.js" type="text/javascript"></script>
  <script src="./js/connect_four.js" type="text/javascript"></script>

  <script type="text/javascript">
		$(document).ready(function() {
      var drawingCanvas = $('#board').get(0);
      if(drawingCanvas.getContext) {
        var context = drawingCanvas.getContext('2d');
        var connect_four = new ConnectFour();
        var player_color = ['yellow', 'red'];

        // Setup the connect four board
        var cell_size = 100;
        var origin_x = 10;
        var origin_y = 10;
        for (var row = 0; row < 6; row++) {
          var start_x = origin_x;
          var start_y = origin_y;
          var row_pieces = [];

          for (var column = 0; column < 7; column++) {
            context.fillStyle = "white";
            context.fillRect (start_x, start_y, cell_size, cell_size);
            context.strokeStyle = "black";
            context.strokeRect (start_x, start_y, cell_size, cell_size);

            start_x += cell_size;
          }
          origin_y += cell_size;
        }

        $(document).click(function(e) {
          if(!connect_four.has_winner()) {
          var x = e.pageX;
          var y = e.pageY;
          //var row = Math.floor(y / cell_size);
          var column = Math.floor(x / cell_size);

          //if (!connect_four.has_piece(row, column)) {
            if(connect_four.can_add_piece(column)) {
              var row = connect_four.get_next_piece_row(column);
            var cell_center = cell_size / 2;
            var circle_x = ((column * cell_size) + origin_x) + cell_center;
            var circle_y = ((row * cell_size) + origin_x) + cell_center

            context.strokeStyle = 'black';
            context.fillStyle = player_color[connect_four.get_active_player()];
            context.beginPath();
            context.arc(circle_x, circle_y, 40,0, Math.PI*2, true);
            context.closePath();
            context.stroke();
            context.fill();

            connect_four.add_piece(column);
            
            var active_player = connect_four.get_active_player();
            var winning_moves = connect_four.is_winning_move(row, column,
            active_player);
            if (winning_moves) {
              connect_four.set_winner(active_player);
              console.log('wins');

              var end_cell= winning_moves[winning_moves.length - 1];
              var end_x = end_cell[0] * cell_size + origin_x + cell_center;
              var end_y= end_cell[1] * cell_size + origin_x + cell_center;
              var start_x = column * cell_size + origin_x + cell_center;
              var start_y = row * cell_size + origin_x + cell_center;

              context.moveTo(start_x, start_y);
              context.lineTo(end_x, end_y);
              context.stroke();
            }
            else {
              connect_four.change_turn();
            }
          }
          }
        });
      };
    });
	</script>

  <body>
    <canvas id="board" width="800" height="800">
    <p>Your browser doesn't support canvas.</p>
    </canvas>
  </body>
</html>

